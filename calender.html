<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="input.css">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <style>
            /* Keep the sidebar the same size but make it sticky; inner list scrolls */
            :root { --ea-header-h: 0.5rem; --ea-sidebar-shrink: 20px; --ea-sidebar-pt: 12px; --ea-sidebar-pb: 20px; }
            #logo-sidebar {
               position: sticky;
               top: var(--ea-header-h);
               align-self: flex-start;
               z-index: 30;
               display: flex;
               flex-direction: column;
               height: calc(100vh - var(--ea-header-h) - var(--ea-sidebar-shrink)) !important;
               margin-bottom: var(--ea-sidebar-pb); /* extra space below the aside */
               /* width controlled by existing classes (w-62) to keep same size */
            }
            #logo-sidebar .sidebar-inner { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: var(--ea-sidebar-pt); padding-bottom: var(--ea-sidebar-pb); }
            #logo-sidebar .sidebar-inner::after { content: ""; display: block; height: var(--ea-sidebar-pb); width: 1px; }
         </style>
    <title>Dashboard</title>
</head>


<!-- 
<nav class="fixed top-0 z-50 w-full bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
  <div class="px-3 py-3 lg:px-5 lg:pl-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center justify-start rtl:justify-end">
        <button data-drawer-target="logo-sidebar" data-drawer-toggle="logo-sidebar" aria-controls="logo-sidebar" type="button" class="inline-flex items-center p-2 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
            <span class="sr-only">Open sidebar</span>
            <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
               <path clip-rule="evenodd" fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z"></path>
            </svg>
         </button>
        <a href="https://flowbite.com" class="flex ms-2 md:me-24">
          <span class="self-center text-xl font-semibold sm:text-2xl whitespace-nowrap dark:text-white">Empires Academy</span>
        </a>
      </div>
      <div class="flex items-center">
          <div class="flex items-center ms-3">
            <div>
              <button type="button" class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600" aria-expanded="false" data-dropdown-toggle="dropdown-user">
                <span class="sr-only">Open user menu</span>
                <img class="w-8 h-8 rounded-full" src="https://flowbite.com/docs/images/people/profile-picture-5.jpg" alt="user photo">
              </button>
            </div>
            <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-sm shadow-sm dark:bg-gray-700 dark:divide-gray-600" id="dropdown-user">
              <div class="px-4 py-3" role="none">
                <p class="text-sm text-gray-900 dark:text-white" role="none">
                  Neil Sims
                </p>
                <p class="text-sm font-medium text-gray-900 truncate dark:text-gray-300" role="none">
                  neil.sims@flowbite.com
                </p>
              </div>
              <ul class="py-1" role="none">
                <li>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem">Dashboard</a>
                </li>
                <li>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem">Settings</a>
                </li>
                <li>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem">Earnings</a>
                </li>
                <li>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem">Sign out</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
    </div>
  </div>
</nav>

 -->

<div class="flex items-start gap-2">
<aside id="logo-sidebar" class="sticky self-start ms-4 mt-4 w-62 bg-white pt-5 border border-gray-200/40 dark:bg-gray-800 dark:border-gray-700/30 rounded-lg overflow-hidden shadow-2xl" aria-label="Sidebar">
   <div class="sidebar-inner px-2 pb-3 p-3 bg-white dark:bg-gray-800 rounded-lg">
      <ul class="space-y-2 font-medium">
         <li>
            <a href="./dashboard.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21">
                  <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/>
                  <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"/>
               </svg>
               <span class="ms-3">Home</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 18">
                  <path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Categories</span>
            </a>
         </li>
          <li>
            <a href="./academics.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <span class="flex-1 ms-3 whitespace-nowrap">Academics</span>
            </a>
         </li>
          <li>
            <a href="./softskills.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <span class="flex-1 ms-3 whitespace-nowrap">Soft Skills</span>
            </a>
         </li>
          <li>
            <a href="./extra.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <span class="flex-1 ms-3 whitespace-nowrap">Extracurricular Activities</span>
            </a>
         </li>
          <li>
            <a href="./events.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <span class="flex-1 ms-3 whitespace-nowrap">Events</span>
            </a>
         </li>
          <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <span class="flex-1 ms-3 whitespace-nowrap">Performance</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                  <path d="m17.418 3.623-.018-.008a6.713 6.713 0 0 0-2.4-.569V2h1a1 1 0 1 0 0-2h-2a1 1 0 0 0-1 1v2H9.89A6.977 6.977 0 0 1 12 8v5h-2V8A5 5 0 1 0 0 8v6a1 1 0 0 0 1 1h8v4a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-4h6a1 1 0 0 0 1-1V8a5 5 0 0 0-2.582-4.377ZM6 12H4a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Inbox</span>
               <span class="inline-flex items-center justify-center w-3 h-3 p-3 ms-3 text-sm font-medium text-blue-800 bg-blue-100 rounded-full dark:bg-blue-900 dark:text-blue-300">3</span>
            </a>
         </li>
         <li>
            <a href="./profile.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 18">
                  <path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Profile</span>
            </a>
         </li>
         <li>
            <a href="./calender.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 18">
                  <path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Calender</span>
            </a>
         </li>
         <li>
            <a href="./rewards.html" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 18">
                  <path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Reward Store</span>
            </a>
         </li>
      </ul>
   </div>
</aside>

<div class="flex-1 pl-4 sm:pl-8">
<section class="bg-white dark:bg-gray-1000 p-6">
    <div class=" mx-auto">
        <div id="uidDebug" class="mb-4 text-sm text-gray-600">UID: <span id="currentUidDisplay">(not signed)</span></div>
        <!-- Calendar Header -->
        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 md:p-12 mb-8 filter drop-shadow-lg">
            <h1 class="mb-4 text-3xl font-extrabold text-gray-900 dark:text-white md:text-5xl lg:text-6xl"><span class="text-transparent bg-clip-text bg-gradient-to-r to-emerald-600 from-sky-400">Calendar</span></h1>
        </div>

        <!-- Calendar Navigation -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <button id="prevMonth" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h2 id="currentMonth" class="text-2xl font-bold text-gray-900 dark:text-white">September 2025</h2>
                    <button id="nextMonth" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
                <button id="todayBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Today
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-1">
                <!-- Day Headers -->
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Sun</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Mon</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Tue</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Wed</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Thu</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Fri</div>
                <div class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-400">Sat</div>
                
                <!-- Calendar Days -->
                <div id="calendarDays" class="contents">
                    <!-- Days will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Upcoming Events</h3>
            <div id="eventsList" class="space-y-3">
                <!-- Sample Events -->
                <div class="flex items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 dark:text-white">Math Assignment Due</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">September 25, 2025 at 11:59 PM</p>
                    </div>
                    <span class="px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 text-xs rounded-full">Assignment</span>
                </div>
                
                <div class="flex items-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 dark:text-white">Science Fair</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">September 28, 2025 at 9:00 AM</p>
                    </div>
                    <span class="px-2 py-1 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs rounded-full">Event</span>
                </div>
                
                <div class="flex items-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 dark:text-white">English Presentation</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">October 2, 2025 at 2:00 PM</p>
                    </div>
                    <span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 text-xs rounded-full">Presentation</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar JavaScript -->
    <script>
        class Calendar {
            constructor() {
                this.currentDate = new Date();
                this.today = new Date();
                this.selectedDate = null;
                
                this.monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.render();
            }
            
            bindEvents() {
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });
                
                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
                
                document.getElementById('todayBtn').addEventListener('click', () => {
                    this.currentDate = new Date();
                    this.render();
                });
            }
            
            render() {
                this.renderHeader();
                this.renderDays();
            }
            
            renderHeader() {
                const monthYear = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                document.getElementById('currentMonth').textContent = monthYear;
            }
            
            renderDays() {
                const calendarDays = document.getElementById('calendarDays');
                calendarDays.innerHTML = '';
                
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayElement = this.createDayElement(date);
                    calendarDays.appendChild(dayElement);
                }
            }
            
            createDayElement(date) {
                const div = document.createElement('div');
                const isCurrentMonth = date.getMonth() === this.currentDate.getMonth();
                const isToday = this.isSameDay(date, this.today);
                const isPast = date < this.today && !isToday;
                
                div.className = `
                    p-3 text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors
                    ${isCurrentMonth ? 'text-gray-900 dark:text-white' : 'text-gray-400 dark:text-gray-600'}
                    ${isToday ? 'bg-blue-600 text-white rounded-lg font-bold' : ''}
                    ${isPast && isCurrentMonth ? 'opacity-60' : ''}
                `;
                
                div.textContent = date.getDate();
                
                                div.addEventListener('click', () => {
                                        // If a global onDateClick handler exists (added by Firestore module), call it.
                                        if (typeof window.onDateClick === 'function') {
                                            window.onDateClick(new Date(date));
                                        } else {
                                            this.selectedDate = new Date(date);
                                            this.render();
                                        }
                                });
                                // If a global events cache exists, show an indicator dot for days with events
                                try {
                                    if (window.eventsByDate) {
                                        const key = date.toISOString().slice(0,10);
                                        const ev = window.eventsByDate[key];
                                        if (ev && ev.length) {
                                            const dot = document.createElement('div');
                                            dot.className = 'mt-2 flex justify-center';
                                            dot.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span>';
                                            div.appendChild(dot);
                                        }
                                    }
                                } catch (e) {}
                
                return div;
            }
            
            isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }
        }
        
        // Initialize calendar when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new Calendar();
        });
    </script>
</section>

<!-- Firestore events integration -->
<script type="module">
    const firebaseConfig = {
        apiKey: "AIzaSyCT66hhA0ILeNCaAXkwQH_muAVH-JkTXNg",
        authDomain: "afrihack25connect.firebaseapp.com",
        projectId: "afrihack25connect",
        storageBucket: "afrihack25connect.firebasestorage.app",
        messagingSenderId: "233041342533",
        appId: "1:233041342533:web:e3c15cf7c3ddd475c6f32c"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, collectionGroup } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // Simple in-memory cache of events by date (YYYY-MM-DD)
    window.eventsByDate = {};

    function formatDateKey(d) {
        return d.toISOString().slice(0,10);
    }

    async function loadUpcomingEvents() {
        try {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';
            // Determine whether we have a student-scoped events collection
            const todayKey = new Date().toISOString().slice(0,10);
            const uid = (auth && auth.currentUser && auth.currentUser.uid) || localStorage.getItem('currentUserUid') || window.currentUid || null;
            let eventsCol;
            if (uid) {
                const studentDoc = await findStudentDocByUid(uid);
                if (studentDoc && studentDoc.ref) {
                    eventsCol = collection(studentDoc.ref, 'events');
                }
            }
            if (!eventsCol) eventsCol = collection(db, 'events');

            const q = query(eventsCol, orderBy('date', 'asc'));
            const snap = await getDocs(q);
            window.eventsByDate = {};
            const docs = [];
            snap.forEach(d => {
                const data = d.data();
                const date = data.date || '';
                if (!window.eventsByDate[date]) window.eventsByDate[date] = [];
                window.eventsByDate[date].push(Object.assign({id: d.id}, data));
                docs.push(Object.assign({id: d.id}, data));
            });

            // Render upcoming (next 10)
            const upcoming = docs.filter(e => e.date >= todayKey).slice(0,10);
            if (!upcoming.length) {
                const empty = document.createElement('div');
                empty.className = 'text-center text-gray-500';
                empty.textContent = 'No upcoming events.';
                eventsList.appendChild(empty);
                return;
            }

            for (const ev of upcoming) {
                const wrap = document.createElement('div');
                wrap.className = 'flex items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500';
                const main = document.createElement('div');
                main.className = 'flex-1';
                const h = document.createElement('h4');
                h.className = 'font-semibold text-gray-900 dark:text-white';
                h.textContent = ev.title || 'Untitled Event';
                const p = document.createElement('p');
                p.className = 'text-sm text-gray-600 dark:text-gray-400';
                p.textContent = `${ev.date}` + (ev.time ? ` at ${ev.time}` : '');
                main.appendChild(h);
                main.appendChild(p);
                const tag = document.createElement('span');
                tag.className = 'px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 text-xs rounded-full';
                tag.textContent = ev.category || 'Event';
                wrap.appendChild(main);
                wrap.appendChild(tag);
                eventsList.appendChild(wrap);
            }

            // Trigger a re-render of calendar (to show dots)
            if (typeof window.calendarInstance === 'object' && typeof window.calendarInstance.render === 'function') {
                window.calendarInstance.render();
            }
        } catch (e) {
            console.error('Failed to load upcoming events', e);
        }
    }

    // Try to locate a student document for the current user uid.
    async function findStudentDocByUid(uid) {
        if (!uid) return null;
        try {
            // Try collectionGroup for Students with multiple potential field names
            const collNames = ['Students', 'students'];
            const uidFields = ['authUid', 'UID', 'uid'];
            for (const collName of collNames) {
                for (const f of uidFields) {
                    try {
                        const q = query(collectionGroup(db, collName), where(f, '==', uid));
                        const cg = await getDocs(q);
                        if (!cg.empty) return cg.docs[0];
                    } catch (e) { /* ignore */ }
                }
            }
        } catch (e) { /* ignore */ }

        // Try common nested locations: Parent/*/parent1/*/Students/{uid} or Parent/*/Students/{uid}
        try {
            const parents = await getDocs(collection(db, 'Parent'));
            for (const p of parents.docs) {
                try {
                    const maybe = await getDoc(doc(p.ref, 'parent1', 'parent1', 'Students', uid));
                    if (maybe.exists()) return maybe;
                } catch (e) { /* ignore */ }
                try {
                    const maybe2 = await getDoc(doc(p.ref, 'Students', uid));
                    if (maybe2.exists()) return maybe2;
                } catch (e) { /* ignore */ }
            }
        } catch (e) { /* ignore */ }

        // top-level students collection
        try {
            const top = await getDoc(doc(db, 'students', uid));
            if (top.exists()) return top;
        } catch (e) { /* ignore */ }

        return null;
    }

    // Expose handler for date clicks used by calendar
     // Drawer form elements (dynamically created if not present)
     function ensureDrawer() {
        if (document.getElementById('drawer-form')) return;
        const drawer = document.createElement('div');
        drawer.id = 'drawer-form';
        drawer.className = 'fixed top-0 left-0 z-40 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-white w-80 dark:bg-gray-800';
        drawer.setAttribute('tabindex','-1');
        drawer.setAttribute('aria-labelledby','drawer-form-label');
        drawer.innerHTML = `
    <h5 id="drawer-label" class="inline-flex items-center mb-6 text-base font-semibold text-gray-500 uppercase dark:text-gray-400"><svg class="w-3.5 h-3.5 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm14-7.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm-5-4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm-5-4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4Z"/></svg>New Event</h5>
    <button type="button" id="drawer-close" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 inline-flex items-center justify-center dark:hover:bg-gray-600 dark:hover:text-white">
        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
        <span class="sr-only">Close menu</span>
    </button>
    <form id="drawer-form-el" class="mb-6">
        <div class="mb-6">
            <label for="ev-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title</label>
            <input type="text" id="ev-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Event title" required />
        </div>
        <div class="mb-6">
            <label for="ev-desc" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
            <textarea id="ev-desc" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Write event description..."></textarea>
        </div>
        <div class="relative mb-6">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/></svg>
            </div>
            <input id="ev-date" type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="YYYY-MM-DD" required>
        </div>
        <div class="mb-4">
            <label for="ev-time" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Time</label>
            <input id="ev-time" type="text" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="14:00" />
        </div>
        <button id="ev-save" type="submit" class="text-white justify-center flex items-center bg-blue-700 hover:bg-blue-800 w-full focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700">Create event</button>
    </form>
`;
        document.body.appendChild(drawer);
        document.getElementById('drawer-close').addEventListener('click', () => closeDrawer());
          document.getElementById('drawer-form-el').addEventListener('submit', async (e) => {
             e.preventDefault();
             const title = document.getElementById('ev-title').value.trim();
             if (!title) return alert('Title is required');
             const date = document.getElementById('ev-date').value.trim();
             const time = document.getElementById('ev-time').value.trim();
             const desc = document.getElementById('ev-desc').value.trim();
             try {
                 const uid = (auth && auth.currentUser && auth.currentUser.uid) || localStorage.getItem('currentUserUid') || window.currentUid || null;
                 let savedRef = null;
                 if (uid) {
                      const studentDoc = await findStudentDocByUid(uid);
                      if (studentDoc && studentDoc.ref) {
                            savedRef = await addDoc(collection(studentDoc.ref, 'events'), { title, date, time, description: desc, category: 'Event', createdBy: uid });
                      }
                 }
                 if (!savedRef) {
                      savedRef = await addDoc(collection(db, 'events'), { title, date, time, description: desc, category: 'Event', createdBy: uid });
                 }
                 closeDrawer();
                 await loadUpcomingEvents();
             } catch (err) {
                 console.error('Failed saving event', err);
                 alert('Failed to save event');
             }
          });
     }

     function openDrawer() {
        ensureDrawer();
        const d = document.getElementById('drawer-form');
        d.classList.remove('-translate-x-full');
     }

     function closeDrawer() {
        const d = document.getElementById('drawer-form');
        if (d) d.classList.add('-translate-x-full');
     }

     window.onDateClick = function(date) {
        ensureDrawer();
        const key = formatDateKey(date);
        document.getElementById('ev-date').value = key;
        // clear other inputs
        document.getElementById('ev-title').value = '';
        document.getElementById('ev-time').value = '';
        document.getElementById('ev-desc').value = '';
        openDrawer();
     };

    // Provide a hook for calendar to access instance and events cache
    window.calendarReady = function(calendar) {
        window.calendarInstance = calendar;
        loadUpcomingEvents();
    };

    // initial load
    loadUpcomingEvents();

    // Update UID debug element when auth state changes or fallback uid present
    function updateUidDisplay(uid) {
        const el = document.getElementById('currentUidDisplay');
        if (!el) return;
        el.textContent = uid || '(not signed)';
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUid = user.uid;
            localStorage.setItem('currentUserUid', user.uid);
            updateUidDisplay(user.uid);
        } else {
            // Try fallback local uid
            const fallback = localStorage.getItem('currentUserUid') || window.currentUid || null;
            updateUidDisplay(fallback);
        }
    });

    // show fallback uid immediately if present
    updateUidDisplay(localStorage.getItem('currentUserUid') || window.currentUid || null);
</script>



    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    <script src="../path/to/flowbite/dist/flowbite.min.js"></script>
        <script src="./tailwind.config.js"></script>


</body>
</html>